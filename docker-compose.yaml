services:
  # 1. Metadata Database
  metastore-db:
    image: postgres:15
    container_name: hive-metastore-db
    environment:
      POSTGRES_DB: metastore_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 2324
    networks:
      - trino-ranger-net

  # 2. Hive Metastore (HMS)
  hive-metastore:
    image: apache/hive:4.0.0
    container_name: hive-metastore
    depends_on:
      - metastore-db
    environment:
      SERVICE_NAME: "metastore"
      DB_DRIVER: "postgres"
      HIVE_METASTORE_WAREHOUSE_DIR: "s3a://warehouse/"
      
      # Required for the Metastore to "talk" to MinIO
      AWS_ACCESS_KEY_ID: "minioadmin"
      AWS_SECRET_ACCESS_KEY: "minioadmin"
      AWS_REGION: "us-east-1"
      METASTORE_USE_S3: "true"
      
      # This points the Metastore to your MinIO container
      HIVE_METASTORE_S3_ENDPOINT: "http://minio:9000"
      HIVE_METASTORE_S3_PATH_STYLE_ACCESS: "true"
      
      # Connection to the Postgres DB
      SERVICE_OPTS: >-
        -Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver
        -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://hive-metastore-db:5432/metastore_db
        -Djavax.jdo.option.ConnectionUserName=postgres
        -Djavax.jdo.option.ConnectionPassword=2324
    ports:
      - "9083:9083"
    volumes:
      # You must provide the Postgres JDBC driver to the hive libs
      # Or use a volume to persist the warehouse if not using S3/MinIO for all metadata
      - ./lib/postgresql-42.7.8.jar:/opt/hive/lib/postgres.jar
    networks:
      - trino-ranger-net

networks:
  trino-ranger-net:
    external: true
    name: trino_engine_trino-ranger-net